name: E2E Workflow

on:
  push:
    branches: [main]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:24.0.5
        options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Start application with Docker Compose
        run: docker-compose up -d --build

      - name: Wait for services to start
        run: sleep 15

      - name: Step 1 - Create delivery
        run: |
          curl -X POST http://kong:8000/orders/api/orderService/createDelivery \
               -H "Content-Type: application/json" \
               -d '{"id": "1","customerName": "Peter","address": "Boeksbrug","status": "Created"}'

      - name: Step 2 - Get delivery ID from orderId
        id: get_delivery_id
        run: |
          DELIVERY_ID=$(curl -s "http://kong:8000/api/deliveryservice/deliveryByOrder/1" | jq -r '.id')
          echo "DELIVERY_ID=$DELIVERY_ID" >> $GITHUB_ENV

      - name: Step 3 - Assign driver to delivery
        run: |
          curl -X POST http://kong:8000/api/deliveryservice/assignDeliverer \
               -H "Content-Type: application/json" \
               -d '{"deliveryId": ${{ env.DELIVERY_ID }}, deliverer: {name: "piet", phone: "0612324444"}}'

      - name: Step 4 - Verify delivery is assigned to driver (script)
        run: |
          java -cp ./delivery-service/build/classes/java/test com.swiftbite.services.deliveryService.E2EtestScripts.DelivererAssignedTest

      - name: Step 5 - Complete the delivery
        run: |
          curl -X POST http://kong:8000/api/deliveryservice/completeDelivery/${{ env.DELIVERY_ID }}

      - name: Step 6 - Validate delivery is marked as complete (script)
        run: |
          java -cp ./delivery-service/build/classes/java/test com.swiftbite.services.deliveryService.E2EtestScripts.DeliveryCompletedTest

      - name: Step 7 - Check OrderService received message
        run: |
          docker-compose logs orderservice > orderservice.log
          grep "Received delivery complete for order abc123" orderservice.log

      - name: Cleanup
        if: always()  # Runs even if earlier steps fail
        run: |
          echo "Cleaning up..."
          docker-compose down -v
          rm -f orderservice.log || true

