name: E2E Workflow

on:
  push:
    branches: [master]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:24.0.5
        options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Start application with Docker Compose
        run: docker compose -f ./Backend/Services/docker-compose.yml up -d --build

      - name: Wait for services to start
        run: sleep 30

      - name: Step 1 - Create delivery
        run: |
          curl -X POST http://localhost:8000/orders/api/orderService/createDelivery \
               -H "Content-Type: application/json" \
               -d '{"id": "1","customerName": "Peter","address": "Boeksbrug","status": "Created"}'

      - name: Step 2 - Get delivery ID from orderId
        id: get_delivery_id
        run: |
          DELIVERY_ID=$(curl -s "http://localhost:8000/api/deliveryservice/deliveryByOrder/1" | jq -r '.id')
          echo "DELIVERY_ID=$DELIVERY_ID" >> $GITHUB_ENV

      - name: Step 3 - Assign driver to delivery
        run: |
          curl -X POST http://localhost:8000/api/deliveryservice/assignDeliverer \
               -H "Content-Type: application/json" \
               -d "{\"deliveryId\": \"${{ env.DELIVERY_ID }}\", \"deliverer\": {\"name\": \"piet\", \"phone\": \"0612324444\"}}"

      - name: Wait for MongoDB
        run: |
          echo "Waiting for MongoDB to be available..."
          for i in {1..10}; do
            nc -z localhost 27017 && echo "Mongo is up!" && exit 0
            echo "Still waiting for Mongo..."
            sleep 3
          done
          echo "Mongo did not start in time." && exit 1


      - name: Step 4 - Verify delivery is assigned to driver (script)
        run: |
          cd Backend/Services/Delivery\ Service
          chmod +x ./gradlew
          ./gradlew e2eTest -Dspring.profiles.active=test --tests "com.swiftbite.services.deliveryService.E2EtestScripts.DelivererAssignedTest"


      - name: Step 5 - Complete the delivery
        run: |
          curl -X POST http://localhost:8000/api/deliveryservice/completeDelivery/${{ env.DELIVERY_ID }}

      - name: Step 6 - Validate delivery is marked as complete (script)
        run: |
          cd Backend/Services/Delivery\ Service
          chmod +x ./gradlew
          ./gradlew e2eTest -Dspring.profiles.active=test --tests "com.swiftbite.services.deliveryService.E2EtestScripts.DeliveryCompletedTest"

      - name: Step 7 - Check OrderService received message
        run: |
          docker compose logs orderservice > orderservice.log
          grep "Received delivery complete for order: 1" orderservice.log

      - name: Cleanup
        if: always()  # Runs even if earlier steps fail
        run: |
          echo "Cleaning up..."
          docker-compose down -v
          rm -f orderservice.log || true

